# Calcul Canada

Références: 
* <https://docs.computecanada.ca/wiki/Compute_Canada_Documentation>
* <https://docs.computecanada.ca/wiki/Cedar>
* <https://docs.computecanada.ca/wiki/AI_and_Machine_Learning>
* <https://docs.computecanada.ca/wiki/Handling_large_collections_of_files>
* <https://docs.computecanada.ca/wiki/Tutoriel_Apprentissage_machine/en#Checkpointing_a_long-running_job>
* <https://docs.computecanada.ca/wiki/Python>
* <https://docs.computecanada.ca/wiki/Jupyter>

## Infos compte et expiration
* Se connecter au site <https://ccdb.computecanada.ca/> avec vincent.lefalher@usherbrooke.ca et le mot de passe. 
L'information la plus pertinente ici est la date d'expiration. 

```
Compte Calcul Canada de Vincent Le Falher (CCI: tvh-181, Nom d'utilisateur: vincelf)

Rôles activés
Identifiant de rôle de Calcul Canada (CCRI): tvh-181-01
Étudiant à la maîtrise, Département de géomatique appliquée, Un. de Sherbrooke, activé
expire le 1 mai 2020

Parrainé par
tpb-973-02 , Mickael Germain: Professeur, Département de géomatique appliquée, Un. de Sherbrooke

Projet avec allocation de ressources
Identifiant du projet (RAPI)	Nom du groupe	Statut	Titre	Allocations	Membre?	Responsable?	Propriétaire?
tpb-973-ab	def-germ2201-ab
Activé	Apprentissage profond en télédétection	3 allocations actives - Hors CAR
Oui	Non	Non

Compte
Rôle	
Personne	Vincent Le Falher (CCI: tvh-181)
Nom d'utilisateur	vincelf
Nom du groupe	vincelf
UID	3095395
GID	3095395
Compte par défaut?	Oui
Créé le	2020-01-23 18:55
```

## Connexion
### Prérequis
* Vérifier le status des systèmes: 
<https://status.computecanada.ca/>

Il peut arriver qu'un serveur soit indisponible. 
```
lefv2603@lefv2603-jetsonnano:~$ ssh vincelf@cedar.computecanada.ca
The Cedar login nodes are currently down for emergency maintenance. We appologize for the inconvenience.
```

### Ouvrir une connexion
* Ouvrir un terminal
* faire un nssh sur le serveur désigné. Il y en a qui sont intéressant: cedar (WestGrid), beluga (ETS) et Graham (UofWaterloo)
```
ssh vincelf@cedar.computecanada.ca
ssh vincelf@beluga.computecanada.ca
ssh vincelf@graham.computecanada.ca
```
* Saisir le mot de passe qui a été fourni

Une fois connecté, il y a un espace dans home (~) et ~/projects (/home/vincelf/projects/def-germ2201-ab/vincelf). Les scripts peuvent résider dans le home(~) mais la commande doit être exécuté à partir de ~/projects.

Les scripts de tests se trouvent sur Cedar... qui est en cours de maintenance. Espérons qu'ils seront toujours là !

### Scripts de tests
Référence: <https://docs.computecanada.ca/wiki/PyTorch>

* Créer un emplacement pour les scripts
```
[vincelf@beluga2 pytorch-test]$ pwd
/home/vincelf/gae724/src/pytorch-test
```
* Assigner les variables d'environnements utilisées par le sbatch dans .bashrc
```
# .bashrc

# Source global definitions
if [ -f /etc/bashrc ]; then
	. /etc/bashrc
fi

# Uncomment the following line if you don't like systemctl's auto-paging feature:
# export SYSTEMD_PAGER=
export SLURM_ACCOUNT=def-germ2201-ab
export SBATCH_ACCOUNT=$SLURM_ACCOUNT
export SALLOC_ACCOUNT=$SLURM_ACCOUNT

# User specific aliases and functionsa
alias H='history'
alias Hg='history | grep '
```

* Scripts sbatch de test (adapté)
```
#!/bin/bash
#SBATCH --gres=gpu:1       # Request GPU "generic resources"
#SBATCH --cpus-per-task=6  # Cores proportional to GPUs: 6 on Cedar, 16 on Graham.
#SBATCH --mem=32000M       # Memory proportional to GPUs: 32000 Cedar, 64000 Graham.
#SBATCH --time=0-03:00
#SBATCH --output=%N-%j.out

module load python/3.6 cuda cudnn

SOURCEDIR=~/gae724/src/pytorch-test

# Prepare virtualenv
virtualenv --no-download $SLURM_TMPDIR/env
source $SLURM_TMPDIR/env/bin/activate
pip install --no-index -r $SOURCEDIR/requirements.txt

python pytorch-test.py
```
* Fichier requirements.txt pour python
```
torch
torchvision
torchtext
torchaudio
```

* script de test pytorch
```
import torch
x = torch.Tensor(5, 3)
print(x)
y = torch.rand(5, 3)
print(y)
# let us run the following only if CUDA is available
if torch.cuda.is_available():
  x = x.cuda()
  y = y.cuda()
  print(x + y)
```

### Execution de la tâche (job), statut, résultat et sommaire
Référence: <https://docs.computecanada.ca/wiki/Running_jobs>

* Execution de la tâche (job)
```
[vincelf@beluga2 pytorch-test]$ sbatch pytorch-test.sh
Submitted batch job 6881291
```

* Statut de la tâche
```
[vincelf@beluga2 pytorch-test]$ squeue -u vincelf
          JOBID     USER      ACCOUNT           NAME  ST  TIME_LEFT NODES CPUS TRES_PER_N MIN_MEM NODELIST (REASON) 
        6881568  vincelf def-germ2201 pytorch-test.s   R    2:59:51     1    6 gpu:v100:1  32000M blg5606 (None) 
```
* Sommaire de la tâche
```
[vincelf@beluga2 pytorch-test]$ seff 6881568
Job ID: 6881568
Cluster: beluga
User/Group: vincelf/vincelf
State: COMPLETED (exit code 0)
Nodes: 1
Cores per node: 6
CPU Utilized: 00:00:36
CPU Efficiency: 13.04% of 00:04:36 core-walltime
Job Wall-clock time: 00:00:46
Memory Utilized: 1.95 GB
Memory Efficiency: 6.24% of 31.25 GB
```

* Résultat (output file)
```
[vincelf@beluga2 pytorch-test]$ ls -al
total 113
drwxr-x--- 2 vincelf vincelf 25600 Apr 16 21:58 .
drwxr-x--- 4 vincelf vincelf 25600 Apr 16 21:29 ..
-rw-r----- 1 vincelf vincelf  2805 Apr 16 21:38 blg5207-6881291.out
-rw-r----- 1 vincelf vincelf  2805 Apr 16 21:59 blg5606-6881568.out
-rw-r----- 1 vincelf vincelf   203 Apr 16 21:33 pytorch-test.py
-rwxr-x--- 1 vincelf vincelf   544 Apr 16 21:37 pytorch-test.sh
-rw-r----- 1 vincelf vincelf    39 Apr 16 21:27 requirements.txt
[vincelf@beluga2 pytorch-test]$ cat blg5606-6881568.out

Due to MODULEPATH changes, the following have been reloaded:
  1) openmpi/3.1.2

Using base prefix '/cvmfs/soft.computecanada.ca/easybuild/software/2017/Core/python/3.6.3'
New python executable in /localscratch/vincelf.6881568.0/env/bin/python
Installing setuptools, pip, wheel...done.
Ignoring pip: markers 'python_version < "3"' don't match your environment
Collecting torch (from -r /home/vincelf/gae724/src/pytorch-test/requirements.txt (line 1))
Collecting torchvision (from -r /home/vincelf/gae724/src/pytorch-test/requirements.txt (line 2))
Collecting torchtext (from -r /home/vincelf/gae724/src/pytorch-test/requirements.txt (line 3))
Collecting torchaudio (from -r /home/vincelf/gae724/src/pytorch-test/requirements.txt (line 4))
Collecting numpy (from torchvision->-r /home/vincelf/gae724/src/pytorch-test/requirements.txt (line 2))
Collecting six (from torchvision->-r /home/vincelf/gae724/src/pytorch-test/requirements.txt (line 2))
Collecting pillow-simd>=4.1.1 (from torchvision->-r /home/vincelf/gae724/src/pytorch-test/requirements.txt (line 2))
Collecting tqdm (from torchtext->-r /home/vincelf/gae724/src/pytorch-test/requirements.txt (line 3))
Collecting requests (from torchtext->-r /home/vincelf/gae724/src/pytorch-test/requirements.txt (line 3))
Collecting chardet<4,>=3.0.2 (from requests->torchtext->-r /home/vincelf/gae724/src/pytorch-test/requirements.txt (line 3))
Collecting certifi>=2017.4.17 (from requests->torchtext->-r /home/vincelf/gae724/src/pytorch-test/requirements.txt (line 3))
Collecting urllib3!=1.25.0,!=1.25.1,<1.26,>=1.21.1 (from requests->torchtext->-r /home/vincelf/gae724/src/pytorch-test/requirements.txt (line 3))
Collecting idna<3,>=2.5 (from requests->torchtext->-r /home/vincelf/gae724/src/pytorch-test/requirements.txt (line 3))
Installing collected packages: torch, numpy, six, pillow-simd, torchvision, tqdm, chardet, certifi, urllib3, idna, requests, torchtext, torchaudio
Successfully installed certifi-2020.4.5.1 chardet-3.0.4 idna-2.9 numpy-1.18.1 pillow-simd-7.0.0.post3 requests-2.23.0 six-1.14.0 torch-1.4.0 torchaudio-0.2+7e15d2f torchtext-0.3.1 torchvision-0.5.0 tqdm-4.40.2 urllib3-1.25.8
tensor([[1.7036e+19, 6.8388e-40, 1.8206e-34],
        [2.8422e-14, 1.4013e-45, 7.2824e-34],
        [0.0000e+00, 0.0000e+00, 4.2039e-45],
        [8.7861e-43, 0.0000e+00, 0.0000e+00],
        [0.0000e+00, 0.0000e+00, 0.0000e+00]])
tensor([[0.4264, 0.8394, 0.9436],
        [0.8938, 0.9715, 0.7171],
        [0.5885, 0.2864, 0.7367],
        [0.1345, 0.8238, 0.1028],
        [0.2600, 0.5384, 0.8122]])
tensor([[1.7036e+19, 8.3940e-01, 9.4355e-01],
        [8.9376e-01, 9.7147e-01, 7.1707e-01],
        [5.8849e-01, 2.8635e-01, 7.3668e-01],
        [1.3446e-01, 8.2377e-01, 1.0282e-01],
        [2.5999e-01, 5.3839e-01, 8.1223e-01]], device='cuda:0')
```
